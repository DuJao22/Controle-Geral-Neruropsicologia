{% extends "base.html" %}

{% block title %}{{ paciente.nome }} - Sistema Neuropsicologia{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Patient Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3">
                        <i class="fas fa-user me-2"></i>{{ paciente.nome }}
                    </h1>
                    <p class="text-muted mb-0">
                        CPF: {{ paciente.cpf }} | 
                        {% if paciente.carteirinha %}Carteirinha: {{ paciente.carteirinha }} | {% endif %}
                        Médico: {{ paciente.medico_nome }} | 
                        Local: {{ paciente.localizacao }} |
                        {% if dias_restantes >= 0 %}
                            <span class="text-{% if dias_restantes <= 7 %}warning{% else %}success{% endif %}">
                                {{ dias_restantes }} dias para entrega do laudo
                            </span>
                        {% else %}
                            <span class="text-danger">{{ dias_restantes * -1 }} dias em atraso para laudo</span>
                        {% endif %}
                    </p>
                </div>
                <div>
                    {% if paciente.status == 'ativo' %}
                        <span class="badge bg-success fs-6">Ativo</span>
                    {% else %}
                        <span class="badge bg-secondary fs-6">Finalizado</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Sessions Section -->
        <div class="col-md-6">
            <div class="card modern">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-check me-2"></i>
                        Sessões ({{ sessoes|length }}/8)
                    </h5>
                    {% if sessoes|length < 8 and paciente.status == 'ativo' %}
                    <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#novaSessaoModal">
                        <i class="fas fa-plus me-1"></i>Nova Sessão
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if sessoes %}
                    <div class="list-group list-group-flush">
                        {% for sessao in sessoes %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">{{ sessao.numero }}ª Sessão</h6>
                                    <p class="mb-1 text-muted">{{ sessao.data }}</p>
                                    {% if sessao.observacoes %}
                                    <small class="text-muted">{{ sessao.observacoes }}</small>
                                    {% endif %}
                                </div>
                                <span class="badge bg-primary">Realizada</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted text-center">Nenhuma sessão registrada.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Passwords Section -->
        <div class="col-md-6">
            <div class="card modern">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-key me-2"></i>
                        Senhas de Convênio
                    </h5>
                    {% if sessoes|length <= 4 and paciente.status == 'ativo' %}
                    <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#novaSenhaModal">
                        <i class="fas fa-plus me-1"></i>Nova Senha
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if senhas %}
                    <div class="list-group list-group-flush">
                        {% for senha in senhas %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">
                                        {% if senha.tipo == 'consulta' %}
                                        <i class="fas fa-user-md me-1"></i>Consulta
                                        {% else %}
                                        <i class="fas fa-flask me-1"></i>Teste
                                        {% endif %}
                                    </h6>
                                    <p class="mb-0 text-muted">
                                        Número: {{ senha.numero }}<br>
                                        Valor: {% if senha.valor == "***" %}{{ senha.valor }}{% else %}R$ {{ "%.2f"|format(senha.valor) }}{% endif %}
                                    </p>
                                </div>
                                <span class="badge bg-{% if senha.status == 'pendente' %}warning{% elif senha.status == 'liberada' %}success{% else %}secondary{% endif %}">
                                    {{ senha.status.title() }}
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Total Value -->
                    <div class="mt-3 p-2 bg-light rounded">
                        <strong>Total: {% if senhas and senhas[0].valor == "***" %}Confidencial{% else %}R$ {{ "%.2f"|format(senhas|sum(attribute='valor')) }}{% endif %}</strong>
                    </div>
                    {% else %}
                    <p class="text-muted text-center">Nenhuma senha cadastrada.</p>
                    {% endif %}
                    
                    {% if sessoes|length > 4 %}
                    <div class="alert alert-info mt-3 mb-0">
                        <small>
                            <i class="fas fa-info-circle me-1"></i>
                            Senhas só podem ser cadastradas até a 4ª sessão.
                        </small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Laudo Section -->
        <div class="col-12">
            <div class="card modern">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-file-pdf me-2"></i>
                        Laudo Final
                    </h5>
                </div>
                <div class="card-body">
                    {% if laudo %}
                    <div class="alert alert-success">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="alert-heading mb-1">
                                    <i class="fas fa-check-circle me-1"></i>
                                    Laudo Enviado
                                </h6>
                                <p class="mb-0">Enviado em: {{ laudo.data_upload }}</p>
                            </div>
                            <a href="{{ url_for('download_laudo', filename=laudo.caminho_arquivo) }}" 
                               class="btn btn-success btn-sm" target="_blank">
                                <i class="fas fa-download me-1"></i>Download
                            </a>
                        </div>
                    </div>
                    {% else %}
                    {% if sessoes|length >= 8 or paciente.status == 'finalizado' %}
                    <p class="text-muted mb-3">Nenhum laudo enviado ainda.</p>
                    {% endif %}
                    
                    {% if paciente.status == 'ativo' %}
                    {% if sessoes|length >= 8 %}
                    <form method="POST" action="{{ url_for('upload_laudo') }}" enctype="multipart/form-data">
                        <input type="hidden" name="paciente_id" value="{{ paciente.id }}">
                        <div class="mb-3">
                            <label for="arquivo" class="form-label">Arquivo do Laudo</label>
                            <input type="file" class="form-control" id="arquivo" name="arquivo" required>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="finalizar" name="finalizar">
                            <label class="form-check-label" for="finalizar">
                                Finalizar paciente após envio
                            </label>
                        </div>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-upload me-1"></i>Enviar Laudo
                        </button>
                    </form>
                    {% else %}
                    <div class="alert alert-warning">
                        <h6 class="alert-heading">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            Pré-requisito não atendido
                        </h6>
                        <p class="mb-2">Para enviar o laudo, é necessário:</p>
                        <ul class="mb-3">
                            <li>Ter realizado 8 sessões (atual: {{ sessoes|length }})</li>
                            <li>OU marcar como "Finalizar paciente"</li>
                        </ul>
                        
                        <form method="POST" action="{{ url_for('upload_laudo') }}" enctype="multipart/form-data">
                            <input type="hidden" name="paciente_id" value="{{ paciente.id }}">
                            <div class="mb-3">
                                <label for="arquivo" class="form-label">Arquivo do Laudo</label>
                                <input type="file" class="form-control" id="arquivo" name="arquivo" required>
                            </div>
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="finalizar" name="finalizar" required>
                                <label class="form-check-label" for="finalizar">
                                    <strong>Finalizar paciente (obrigatório se menos de 8 sessões)</strong>
                                </label>
                            </div>
                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-upload me-1"></i>Enviar Laudo e Finalizar
                            </button>
                        </form>
                    </div>
                    {% endif %}
                    {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer com Créditos -->
    <div class="mt-5 mb-3 text-center">
        <small class="text-muted">
            <i class="fas fa-brain me-1 text-success"></i>
            Sistema Neuropsicológico - Desenvolvido por <strong>João Layon</strong>
        </small>
    </div>
</div>

<!-- New Session Modal -->
<div class="modal fade" id="novaSessaoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nova Sessão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('adicionar_sessao') }}">
                <div class="modal-body">
                    <input type="hidden" name="paciente_id" value="{{ paciente.id }}">
                    <div class="mb-3">
                        <label for="data" class="form-label">Data da Sessão</label>
                        <input type="date" class="form-control" id="data" name="data" required>
                    </div>
                    <div class="mb-3">
                        <label for="observacoes" class="form-label">Observações (opcional)</label>
                        <textarea class="form-control" id="observacoes" name="observacoes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Adicionar Sessão</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- New Password Modal -->
<div class="modal fade" id="novaSenhaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nova Senha de Convênio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('adicionar_senha') }}">
                <div class="modal-body">
                    <input type="hidden" name="paciente_id" value="{{ paciente.id }}">
                    <div class="mb-3">
                        <label for="tipo" class="form-label">Tipo de Senha</label>
                        <select class="form-control" id="tipo" name="tipo" required onchange="updateSenhaInfo()">
                            <option value="">Selecione o tipo</option>
                            {% set has_consulta = senhas|selectattr('tipo', 'equalto', 'consulta')|list|length > 0 %}
                            {% set has_teste = senhas|selectattr('tipo', 'equalto', 'teste')|list|length > 0 %}
                            {% if not has_consulta %}
                            <option value="consulta">Consulta Neuropsicologia</option>
                            {% endif %}
                            {% if not has_teste %}
                            <option value="teste">Teste Neuropsicologia</option>
                            {% endif %}
                        </select>
                    </div>
                    <div id="senhaInfo" class="alert alert-info" style="display: none;">
                        <div id="senhaDetails"></div>
                    </div>
                    <div class="mb-3">
                        <label for="numero" class="form-label">Número da Senha</label>
                        <input type="text" class="form-control" id="numero" name="numero" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Adicionar Senha</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function updateSenhaInfo() {
    const tipo = document.getElementById('tipo').value;
    const senhaInfo = document.getElementById('senhaInfo');
    const senhaDetails = document.getElementById('senhaDetails');
    
    
}

// Set today's date as default
document.getElementById('data').valueAsDate = new Date();
</script>
{% endblock %}
